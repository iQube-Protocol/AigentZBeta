<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>QubeAgent Interaction</title>
    
    <!-- Ethers.js library -->
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>

    <style>
        :root {
            --primary-color: #6366f1;
            --primary-hover: #4f46e5;
            --secondary-color: #64748b;
            --background-color: #ffffff;
            --card-background: #f8fafc;
            --text-color: #1e293b;
            --border-color: #e2e8f0;
            --success-color: #22c55e;
            --error-color: #ef4444;
            --border-radius: 0.75rem;
            --metaqube-bg: rgba(34, 197, 94, 0.1);
            --blakqube-bg: rgba(239, 68, 68, 0.1);
            --button-bg: #f1f5f9;
            --button-hover: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .section {
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: var(--text-color);
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 2rem;
        }

        h2 {
            color: var(--text-color);
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        h3 {
            color: var(--text-color);
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
        }

        button {
            background-color: var(--button-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            width: 100%;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        button:hover {
            background-color: var(--button-hover);
            transform: translateY(-1px);
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: white;
            color: var(--text-color);
            font-size: 1rem;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .qube-data {
            margin-bottom: 1.5rem;
        }

        .data-field {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            width: 100%;
            min-width: 0;
        }

        /* Common styles for all field labels and values */
        .field-label {
            display: block;
            background: var(--button-bg);
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            width: 100%;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .field-value {
            padding: 0.75rem;
            border-radius: var(--border-radius);
            font-family: 'Courier New', Courier, monospace;
            word-break: break-all;
            width: 100%;
            text-align: center;
            min-height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            overflow: hidden;
            word-wrap: break-word;
            word-break: break-word;
        }

        .metaqube-value {
            background: var(--metaqube-bg);
        }

        .blakqube-value {
            background: var(--blakqube-bg);
        }

        /* Container for both MetaQube and BlakQube data */
        .metaqube-grid {
            display: grid;
            gap: 1rem;
            width: 100%;
        }

        /* Common row styles */
        .metaqube-row {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 1rem;
            width: 100%;
        }

        /* Special handling for the scores row */
        .metaqube-row:last-child {
            grid-template-columns: repeat(5, 1fr);
        }

        /* BlakQube grid to match MetaQube row width */
        #blakQubeDetails {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 1rem;
            width: 100%;
            max-width: 100%;
        }

        /* Ensure data fields take full width */
        .data-field {
            width: 100%;
        }

        /* Consistent field styles */
        .field-label {
            display: block;
            background: var(--button-bg);
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            width: 100%;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .field-value {
            padding: 0.75rem;
            border-radius: var(--border-radius);
            font-family: 'Courier New', Courier, monospace;
            word-break: break-all;
            width: 100%;
            text-align: center;
            min-height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            overflow: hidden;
            word-wrap: break-word;
            word-break: break-word;
        }

        /* Ensure all content is contained */
        .card-content {
            width: 100%;
            overflow: hidden;
        }

        /* Text wrapping for all content */
        p, div, span {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.875rem;
            }

            h2 {
                font-size: 1.25rem;
            }

            .metaqube-row,
            #blakQubeDetails {
                grid-template-columns: 1fr;
            }

            .metaqube-row:last-child {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
    
    <script>
        // Global logging mechanism
        (function() {
            window.debugLog = function(type, message) {
                try {
                    console.log(`[${type || 'INFO'}] ${message}`);
                    
                    const debugOutput = document.getElementById('debugOutput');
                    if (debugOutput) {
                        debugOutput.textContent += `[${type || 'INFO'}] ${message}\n`;
                    }
                } catch (e) {
                    console.error('Logging failed:', e);
                }
            };

            // Global error handler
            window.onerror = function(message, source, lineno, colno, error) {
                window.debugLog('error', `Global Error: ${message} at ${source}:${lineno}`);
                return false;
            };

            window.debugLog('info', 'Logging mechanism initialized');
        })();

        // Add Web3 and ethers.js
        const script = document.createElement('script');
        script.src = "https://cdn.ethers.io/lib/ethers-5.0.umd.min.js";
        document.head.appendChild(script);

        let provider;
        let signer;
        let connectedAddress;

        // Connect wallet function
        window.connectWallet = async function() {
            try {
                // Check if MetaMask is installed
                if (!window.ethereum) {
                    throw new Error('Please install MetaMask to connect your wallet');
                }

                // Request account access
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                connectedAddress = accounts[0];
                
                // Initialize ethers provider and signer
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                
                // Send the address to the backend
                const response = await fetch('/connect_wallet', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        address: connectedAddress
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'error') {
                    throw new Error(data.message);
                }
                
                // Update UI to show connected state
                const connectButton = document.getElementById('connectWallet');
                connectButton.textContent = `Connected: ${connectedAddress.substring(0, 6)}...${connectedAddress.substring(38)}`;
                connectButton.disabled = true;
                
                window.debugLog('info', `Wallet connected: ${connectedAddress}`);
            } catch (error) {
                window.debugLog('error', `Wallet connection error: ${error.message}`);
                alert(`Failed to connect wallet: ${error.message}`);
            }
        };

        // View MetaQube function
        window.viewMetaQube = async function() {
            try {
                // Check if wallet is connected
                if (!connectedAddress) {
                    throw new Error('Please connect your wallet first');
                }

                const tokenQubeId = document.getElementById('tokenQubeId').value;
                
                if (!tokenQubeId) {
                    throw new Error('Please enter a TokenQube ID');
                }

                const response = await fetch(`/retrieve_tokeqube/${tokenQubeId}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                // Format MetaQube HTML
                const metaQubeHtml = `
                    <div class="metaqube-grid">
                        <div class="metaqube-row">
                            <div class="data-field">
                                <div class="field-label">iQube Identifier</div>
                                <div class="field-value metaqube-value">${data.metaQube.iQubeIdentifier}</div>
                            </div>
                            <div class="data-field">
                                <div class="field-label">iQube Creator</div>
                                <div class="field-value metaqube-value">${data.metaQube.iQubeCreator}</div>
                            </div>
                        </div>
                        <div class="metaqube-row">
                            <div class="data-field">
                                <div class="field-label">Owner Type</div>
                                <div class="field-value metaqube-value">${data.metaQube.ownerType}</div>
                            </div>
                            <div class="data-field">
                                <div class="field-label">Owner Identifiability</div>
                                <div class="field-value metaqube-value">${data.metaQube.ownerIdentifiability}</div>
                            </div>
                        </div>
                        <div class="metaqube-row">
                            <div class="data-field">
                                <div class="field-label">Content Type</div>
                                <div class="field-value metaqube-value">${data.metaQube.iQubeContentType}</div>
                            </div>
                            <div class="data-field">
                                <div class="field-label">Transaction Date</div>
                                <div class="field-value metaqube-value">${data.metaQube.transactionDate}</div>
                            </div>
                        </div>
                        <div class="metaqube-row">
                            <div class="data-field">
                                <div class="field-label">Sensitivity</div>
                                <div class="field-value metaqube-value">${data.metaQube.sensitivityScore}</div>
                            </div>
                            <div class="data-field">
                                <div class="field-label">Verifiability</div>
                                <div class="field-value metaqube-value">${data.metaQube.verifiabilityScore}</div>
                            </div>
                            <div class="data-field">
                                <div class="field-label">Accuracy</div>
                                <div class="field-value metaqube-value">${data.metaQube.accuracyScore}</div>
                            </div>
                            <div class="data-field">
                                <div class="field-label">Risk</div>
                                <div class="field-value metaqube-value">${data.metaQube.riskScore}</div>
                            </div>
                            <div class="data-field">
                                <div class="field-label">Trust</div>
                                <div class="field-value metaqube-value">${data.metaQube.trustScore}</div>
                            </div>
                        </div>
                    </div>
                `;

                // Format BlakQube HTML
                const blakQubeEntries = Object.entries(data.blakQube);
                const blakQubeHtml = blakQubeEntries
                    .map(([key, value]) => `
                        <div class="data-field">
                            <div class="field-label">${key}</div>
                            <div class="field-value blakqube-value">${value}</div>
                        </div>
                    `).join('');

                // Update DOM
                document.getElementById('metaQubeDetails').innerHTML = metaQubeHtml;
                document.getElementById('blakQubeDetails').innerHTML = blakQubeHtml;
                document.getElementById('metaQubeData').classList.add('visible');

                window.debugLog('info', `MetaQube viewed: ${tokenQubeId}`);
            } catch (error) {
                window.debugLog('error', `MetaQube view error: ${error.message}`);
                alert(`View failed: ${error.message}`);
            }
        };

        // Share iQube Function
        window.shareIQube = async function() {
            try {
                const tokenQubeId = document.getElementById('tokenQubeId').value;
                const iQubeType = document.getElementById('iQubeType').value;
                const contextValue = document.getElementById('contextValue').value;

                if (!tokenQubeId) {
                    throw new Error('Please enter a TokenQube ID');
                }

                // First share the iQube and decrypt BlakQube data
                const shareResponse = await fetch('/share_iqube', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tokenQubeId,
                        iQubeType,
                        contextValue
                    })
                });

                const shareData = await shareResponse.json();
                
                if (shareData.status === 'error') {
                    throw new Error(shareData.message);
                }

                // Display decrypted data
                const decryptedDataHtml = Object.entries(shareData.decryptedData)
                    .map(([key, value]) => `
                        <div class="data-field">
                            <div class="field-label">${key}</div>
                            <div class="field-value">${value}</div>
                        </div>
                    `).join('');

                document.getElementById('decryptedData').innerHTML = `
                    <h3>Decrypted BlakQube Data</h3>
                    <div class="decrypted-grid">
                        ${decryptedDataHtml}
                    </div>
                `;

                window.debugLog('info', `iQube shared successfully: ${tokenQubeId}`);
                alert('iQube shared successfully with QubeAgent');
            } catch (error) {
                window.debugLog('error', `Share iQube error: ${error.message}`);
                alert(`Share failed: ${error.message}`);
            }
        };

        // QubeAgent Context Update Function
        window.updateQubeAgentContext = async function() {
            try {
                window.debugLog('info', 'Updating QubeAgent Context...');
                
                const contextUpdate = document.getElementById('contextUpdate').value;
                
                const response = await fetch('/update_context', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        context: contextUpdate
                    })
                });

                const updateResult = await response.json();
                
                const contextUpdateResult = document.getElementById('contextUpdateResult');
                contextUpdateResult.textContent = JSON.stringify(updateResult, null, 2);
                
                window.debugLog('info', 'QubeAgent Context Updated');
            } catch (error) {
                window.debugLog('error', `Context update error: ${error.message}`);
                alert(`Context update failed: ${error.message}`);
            }
        };

        // Agent Context Summary Function
        window.getAgentContextSummary = async function() {
            try {
                window.debugLog('info', 'Retrieving Agent Context Summary...');
                
                const response = await fetch('/agent_context_summary');
                const contextSummary = await response.json();
                
                const agentContextSummary = document.getElementById('agentContextSummary');
                agentContextSummary.textContent = JSON.stringify(contextSummary, null, 2);
                
                window.debugLog('info', 'Agent Context Summary Retrieved');
            } catch (error) {
                window.debugLog('error', `Context summary error: ${error.message}`);
                alert(`Context summary retrieval failed: ${error.message}`);
            }
        };

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const connectButton = document.getElementById('connectWallet');
            if (connectButton) {
                connectButton.addEventListener('click', window.connectWallet);
            }
        });

        window.debugLog('info', 'Interaction scripts initialized');
    </script>
</head>
<body>
    <div class="container">
        <h1>QubeAgent Interface</h1>

        <div class="section" id="walletConnection">
            <h2>1. Wallet Connection</h2>
            <button id="connectWallet">Connect Wallet</button>
            <p id="walletStatus"></p>
        </div>

        <div class="section" id="metaQubeSection">
            <h2>2. View MetaQube</h2>
            <input type="text" id="tokenQubeId" placeholder="Enter TokenQube ID">
            <button onclick="window.viewMetaQube()">View MetaQube</button>
            <div id="metaQubeData" style="margin-top: 1rem;">
                <div class="qube-data">
                    <h3>MetaQube Data</h3>
                    <pre id="metaQubeDetails"></pre>
                </div>
                <div class="qube-data">
                    <h3>BlakQube Data (Encrypted)</h3>
                    <pre id="blakQubeDetails"></pre>
                </div>
            </div>
        </div>

        <div class="section" id="iQubeShareSection">
            <h2>3. Share iQube with QubeAgent</h2>
            <select id="iQubeType">
                <option value="personal">Personal</option>
                <option value="professional">Professional</option>
                <option value="academic">Academic</option>
            </select>
            <textarea id="contextValue" placeholder="Enter iQube context"></textarea>
            <button onclick="window.shareIQube()">Share iQube</button>
            <div id="blakQubeDataSection" style="display: none;">
                <h6 class="mt-3">BlakQube Data (Encrypted)</h6>
                <div id="blakQubeData" class="row"></div>
                
                <!-- Decrypted BlakQube Data Section -->
                <h6 class="mt-4">BlakQube Data (Decrypted)</h6>
                <div id="decryptedBlakQubeData" class="row"></div>
            </div>
        </div>

        <div class="section" id="contextUpdateSection">
            <h2>4. QubeAgent Context Update</h2>
            <textarea id="contextUpdate" placeholder="Enter context update"></textarea>
            <button onclick="window.updateQubeAgentContext()">Update Context</button>
            <pre id="contextUpdateResult"></pre>
        </div>

        <div class="section" id="agentContextSection">
            <h2>5. Agent Context Summary</h2>
            <button onclick="window.getAgentContextSummary()">Get Context Summary</button>
            <pre id="agentContextSummary"></pre>
        </div>

        <div class="section">
            <h2>Debug Output</h2>
            <pre id="debugOutput"></pre>
        </div>
    </div>

    <script>
        function displayDecryptedData(decryptedData) {
            const decryptedContainer = document.getElementById('decryptedBlakQubeData');
            decryptedContainer.innerHTML = ''; // Clear existing content
            
            // Create and append key-value pairs for decrypted data
            Object.entries(decryptedData).forEach(([key, value]) => {
                const col = document.createElement('div');
                col.className = 'col-md-6 mb-2';
                
                const card = document.createElement('div');
                card.className = 'card h-100';
                card.style.backgroundColor = '#e8f5e9'; // Light green background
                
                const cardBody = document.createElement('div');
                cardBody.className = 'card-body p-2';
                
                const content = document.createElement('p');
                content.className = 'mb-0';
                content.innerHTML = `<strong>${key}:</strong> ${value}`;
                
                cardBody.appendChild(content);
                card.appendChild(cardBody);
                col.appendChild(card);
                decryptedContainer.appendChild(col);
            });
            
            // Show the BlakQube data section
            document.getElementById('blakQubeDataSection').style.display = 'block';
        }

        async function shareIQube() {
            try {
                const tokenQubeId = document.getElementById('tokenQubeId').value;
                
                const response = await fetch('/share_iqube', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tokenQubeId: tokenQubeId,
                        iQubeType: 'data'
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    // Display the decrypted data
                    displayDecryptedData(data.decryptedData);
                } else {
                    console.error('Error sharing iQube:', data.message);
                }
            } catch (error) {
                console.error('Error sharing iQube:', error);
            }
        }
    </script>
</body>
</html>
