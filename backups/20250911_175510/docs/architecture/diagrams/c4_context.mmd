%% C4-Context (simplified with Mermaid)
flowchart LR
  subgraph Users
    U[End User]
    Admin[Operator/Admin]
  end

  subgraph ExternalUI[External UI (Provided by Product Owner)]
    UI[Web App / Chat UI]
  end

  U -- uses --> UI
  Admin -- operates --> UI

  subgraph AigentZ[Aigent Z Beta Platform]
    direction TB
    OG[Orchestration Layer\n- Agent Runner\n- MCP Client\n- A2A Adapter]
    CTX[Context Layer\n- iQube Resolver\n- Policy Engine\n- Memory Manager]
    SRV[Services Layer\n- API Gateway\n- Identity/Payments\n- CrossChain (LZ)\n- Registry / ERC-8004\n- FIO Adapter]
    ST[State Layer\n- Supabase (Postgres+RLS)\n- Object Store (blobs)\n- Audit/Telemetry]
  end

  UI -- REST/WebSocket (OpenAPI/SDK) --> SRV
  SRV -- "RLS-enforced SQL\n(App state)" --> ST
  OG -- "Context/Actions" --> CTX
  CTX -- "Read/Write\n(mem_*, iQube refs)" --> ST
  OG -- "Tool/Action Calls" --> SRV

  subgraph Chains[Blockchain & Registries]
    direction TB
    EVM[EVM Chains\n(ERC-8004, Payments, TokenGates)]
    LZ[LayerZero OApp/OFT]
    FIO[FIO Protocol (Handles)]
    REG[iQube Registry (metaQubes index)]
    ICP[ICP / Bitcoin (21 Sats)\n(Chain-key BTC, Ordinals/Runes)]
  end

  SRV --- EVM
  SRV --- FIO
  SRV --- LZ
  SRV --- REG
  SRV --- ICP

  classDef box fill:#0b7285,stroke:#083344,color:#fff,stroke-width:1px;
  classDef light fill:#94d2bd,stroke:#0b525b,color:#003049,stroke-width:1px;
  classDef user fill:#adb5bd,stroke:#495057,color:#212529,stroke-width:1px;
  classDef chain fill:#ffdd99,stroke:#e07a00,color:#5b3200,stroke-width:1px;

  class AigentZ box;
  class OG,CTX,SRV,ST light;
  class U,Admin user;
  class EVM,LZ,FIO,REG,ICP chain;
